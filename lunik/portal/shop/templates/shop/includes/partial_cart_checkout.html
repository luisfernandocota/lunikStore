{% load thumbnail %}
{% load humanize %}
{% load tags %}
<div class="row container-table-cart">
  <div class="col-md-9">
    <div class="row">
      <div class="col-md-12">
        <div class="img-cart pos-relative">
          <div class="wrap-table-shopping-cart bgwhite">
            <table class="table-shopping-cart">
              <tr class="table-head">
                <th class="column-1"></th>
                <th class="column-3">Producto</th>
                <th class="column-4">Precio</th>
                <th class="column-2">Cantidad</th>
                <th class="column-2">Envio</th>
                <th class="column-2">Total</th>
              </tr>
              {% if cart.get_quantity_products > 0 %}
              {% for item in cart %}
              {% for key in item.variants.keys %}
              <tr class="table-row">
                <td class="column-1">
                  <div class="header-cart-item-img remove-cart-item"
                    data-url="{% if request.is_secure %}https://{% else %}http://{% endif %}{{request.get_host}}{% url 'shop:cart_remove' %}"
                    data-product="{{item.product.pk}}" data-size="{{key|get_sizes_cart:item}}" data-checkout="0">
                    {% with image=item.product.product.products_gallery.all.first.image %}
                    {% thumbnail image '100x100' crop='center' as img %}
                    <img src="{{img.url}}">
                    {% endthumbnail %}
                    {% endwith %}
                  </div>
                </td>
                <td class="column-2">{{item.product.product}}</td>
                <td class="column-4">${{key|get_charge_price_cart:item|intcomma}}</td>
                <td class="column-5">
                  <div class="flex-w bo5 of-hidden w-size17">
                    <!-- <button class="btn-num-product-down color1 flex-c-m size7 bg8 eff2">
                      <i class="fs-12 fa fa-minus" aria-hidden="true"></i>
                    </button> -->

                    <input name="quantity" value="{{key|get_quantity_cart:item}}" maxlength="2"
                      class="size4 m-text18 t-center num-product update-cart-item"
                      {% if key|get_custom_price_cart:item > 0 %}readonly=True{% else %}{% endif %}
                      data-url="{% if request.is_secure %}https://{% else %}http://{% endif %}{{request.get_host}}{% url 'shop_cart:cart_update' %}"
                      data-product="{{item.product.pk}}" data-size="{{key|get_sizes_cart:item}}" type="text">
                    <!-- <button class="btn-num-product-up color1 flex-c-m size7 bg8 eff2">
                      <i class="fs-12 fa fa-plus" aria-hidden="true"></i>
                    </button> -->
                  </div>
                </td>
                <td class="column-6">
                {% if item.product.shipping_free or key|get_quantity_cart:item >= item.product.shipping_limit or item.product.shipping is None %}
                ¡Gratis! <i class="fa fa-bolt" style="color:{{store_instance.store_meta.header_color}}"></i>
                {% else %}
                $ {{item.product.shipping|intcomma}}
                {% endif %}
                </td>
                <td class="column-6">
                {% if cart.is_coupon_apply and item.product|coupon:cart.is_coupon_apply and not cart.is_coupon_apply.apply_all  %}
                <span class="block2-oldprice m-text7 p-r-5">
                    ${{key|get_price_after_discount:item|intcomma}}

                </span>
                <br>
                <span class="block2-newprice m-text14">
                  $ {{key|get_total_cart:item|intcomma}} 
                    {% if item.product|coupon:cart.is_coupon_apply and not cart.is_coupon_apply.apply_all %}
                        <i class="fa fa-bullseye"></i>
                    {% endif %}
                  </span>
                {% else %}
                  $ {{key|get_total_cart:item|intcomma}} 
                {% endif %}
                </td>
              </tr>
              {% endfor %}
              {% endfor %}
              {% endif %}
            </table>
          </div>
          {% if cart.is_coupon_apply and not cart.is_coupon_apply.apply_all %}
            <div class="p-b-12" style="float:right;">
              <i class="fa fa-bullseye"></i>
              <span class="s-text5 w-size19 w-full-sm">
                 Producto aplicable al cupón
              </span>
              </div>
            {% endif %}
        </div>
        {% if not cart.is_coupon_apply %}
        <div id="div-coupon" class="flex-w flex-sb-m p-t-25 p-b-25 bo8 p-l-35 p-r-60 p-lr-15-sm">
          <div class="flex-w flex-m w-full-sm">
            <div class="size11 bo4 m-r-10">
              <input id="coupon" class="sizefull s-text7 p-l-22 p-r-22" type="text" name="coupon" placeholder="Codigo">
            </div>

            <div class="size12 trans-0-4 m-t-10 m-b-10 m-r-10">
            <!-- Button -->
              <a data-url="{% url 'shop:apply_coupon' %}" class="flex-c-m sizefull bg1 bo-rad-23 hov1 s-text4 trans-0-4 apply-coupon" style="color:#FFF">

                Aplicar cupón
              </a>
            </div>
          </div>
        </div>
        {% endif %}
        <!-- Total -->
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        {% include 'shop/includes/partial_form_checkout.html' %}
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="col-md-12">
      <div class="pagas bo9 p-l-40 p-r-40 p-t-30 p-b-38 m-t-30 m-r-0 m-l-auto p-lr-15-sm">
        <h5 class="m-text20 p-b-24">
          Pagas
        </h5>
        <!--  -->
        <div class="p-b-12">
          <span class="s-text18 w-size19 w-full-sm">
            Subtotal:
          </span>

          <span class="m-text21 w-size20 w-full-sm">
            ${{cart.get_subtotal_products|intcomma}}
          </span>
          <br>
          {% if cart.is_coupon_apply %}
          <span class="s-text18 w-size19 w-full-sm">
              Cupon:
          </span>

          <span class="m-text21 w-size20 w-full-sm">
            {{cart.is_coupon_apply.code}} - Descuento {% if cart.is_coupon_apply.discount_types == 'A'%}$<strong>{{cart.is_coupon_apply.discount|intcomma}}</strong>{% elif cart.is_coupon_apply.discount_types == 'P'%}<strong>{{cart.is_coupon_apply.discount}}</strong>%{% endif %}
          </span>
          <a class="m-text8 del-coupon" data-url="{% url 'shop:del_coupon' %}" style="color:#e65540; font-size:12px !important">
            Quitar cupón <i class="fa fa-trash-o"></i>
          </a>
          {% endif %}
        </div>

        <!--  -->
        <div class="p-b-12">
          <span class="s-text18 w-size19 w-full-sm">
            Envio:
          </span>

          <span class="m-text21 w-size20 w-full-sm">
          {% if cart.get_shipping_cost > 0 %}
            ${{cart.get_shipping_cost}}
          {% else %}
          ¡Gratis! <i class="fa fa-bolt" style="color:{{store_instance.store_meta.header_color}}"></i>
          {% endif %}
          </span>
        </div>
        <!--  -->
        <div class=" p-t-26 p-b-30">
          <span class="m-text22 w-size19 w-full-sm">
            Total:
          </span>

          <span class="m-text21 w-size20 w-full-sm">
            ${{cart.get_total_products|intcomma}}
          </span>
        </div>
        <div class="size15 trans-0-4">
          <!-- Button -->
          <div id="here">
            {% if cart.get_total_products > 0 and cart.get_quantity_products > 0 %}
            <div id="stripe" class="cart-page-total item2  ">
              {% if request.user.is_client and store_instance.stripe_keys.public_key is None and store_instance.stripe_keys.public_key is None %}
              <div class="flex-c-m sizefull s-text1 trans-0-4">
                <p class="s-text6"> Llena tus llaves de stripe, <a href="{% if request.is_secure %}https://{% else %}http://{% endif %}{{request.get_host}}{% url 'website:meta' %}">ir</a> <i class="fa fa-info-circle" data-toggle="tooltip" data-placement="bottom" title="Tooltip on bottom"></i></p>
              </div>
              {% else %}
            {% if store_instance.stripe_keys.public_key is not None and store_instance.stripe_keys.public_key is not None %}
              {% if request.user.is_customer %}
              <script src="https://checkout.stripe.com/checkout.js" class="stripe-button"
              data-key="{{stripe_keys.public_key}}" data-name="{{store_instance.name}}"
              data-description="Gracias por su compra" data-amount="{{cart.get_total_products_stripe}}"
              data-currency="mxn" data-panel-label="PAGAR" data-label="PAGAR" data-email="{{request.user.email}}"
              data-image="{% if store_instance.store_meta.logo %}{{store_instance.store_meta.logo.url}}{% else %}{{STATIC_URL}}landing/one-page/images/logo_4shop.svg{% endif %}">
              </script>
            <style>
              .stripe-button-el>span {
                background-color: {{store_instance.store_meta.header_color}} !important;
                background-image: linear-gradient({{store_instance.store_meta.header_color}}, {{store_instance.store_meta.header_color}} 100%, {{store_instance.store_meta.header_color}}) !important;
                font-family: Montserrat-Regular;
                font-size: 15px;
                color: white;
                text-transform: uppercase;
              }

              .stripe-button-el {
                border-radius: 23px;
                background-color: #222222 !important;
                border: 1px solid #222222 !important;
                width: 100% !important;
                -webkit-transition: all .3s ease-in !important;
                transition: all .3s ease-in !important;
                height: 100% !important;
                font-weight: 700 !important;
                letter-spacing: 2px !important;
                background-image: linear-gradient({{store_instance.store_meta.header_color}}, {{store_instance.store_meta.header_color}} 100%, {{store_instance.store_meta.header_color}}) !important;
                line-height: 45px !important;
                font-family: Montserrat-Regular;
                font-size: 15px;
                color: white !important;
                text-transform: uppercase;
                display: -webkit-box;
                display: -webkit-flex;
                display: -moz-box;
                display: -ms-flexbox;
                display: flex;
                justify-content: center;
                -ms-align-items: center;
                align-items: center;
                -webkit-transition: all 0.4s;
                -o-transition: all 0.4s;
                -moz-transition: all 0.4s;
                transition: all 0.4s;
              }

              .stripe-button-el:hover {
                background-color: {{store_instance.store_meta.header_color}};
                color: white;
              }
            </style>
              {% else %}
              <div id="info" class="flex-c-m sizefull bg1 bo-rad-23 hov1 s-text1 trans-0-4">
                <p class="s-text14"><i class="fa fa-arrow-left" aria-hidden="true"></i> Llena los campos</p>
              </div>
              {% endif %}
              {% endif %}
              <br>
              <div id="stripe-img" style="float: left:">
                <!-- <a href="https://stripe.com/es-mx" target="_blank"><img src="{{STATIC_URL}}site/images/powered_by_stripe.png" alt="Powered by Stripe"></a> -->
              </div>
            </div> <!-- Style Stripe Button -->
            {% if store_instance.stripe_keys.public_key is not None and store_instance.stripe_keys.public_key is not None %}
            <style>
              .stripe-button-el>span {
                background-color: {{store_instance.store_meta.header_color}} !important;
                background-image: linear-gradient({{store_instance.store_meta.header_color}}, {{store_instance.store_meta.header_color}} 100%, {{store_instance.store_meta.header_color}}) !important;
                font-family: Montserrat-Regular;
                font-size: 15px;
                color: white;
                text-transform: uppercase;
              }

              .stripe-button-el {
                border-radius: 23px;
                background-color: #222222 !important;
                border: 1px solid #222222 !important;
                width: 100% !important;
                -webkit-transition: all .3s ease-in !important;
                transition: all .3s ease-in !important;
                height: 100% !important;
                font-weight: 700 !important;
                letter-spacing: 2px !important;
                background-image: linear-gradient({{store_instance.store_meta.header_color}}, {{store_instance.store_meta.header_color}} 100%, {{store_instance.store_meta.header_color}}) !important;
                line-height: 45px !important;
                font-family: Montserrat-Regular;
                font-size: 15px;
                color: white !important;
                text-transform: uppercase;
                display: -webkit-box;
                display: -webkit-flex;
                display: -moz-box;
                display: -ms-flexbox;
                display: flex;
                justify-content: center;
                -ms-align-items: center;
                align-items: center;
                -webkit-transition: all 0.4s;
                -o-transition: all 0.4s;
                -moz-transition: all 0.4s;
                transition: all 0.4s;
              }

              .stripe-button-el:hover {
                background-color: {{store_instance.store_meta.header_color}};
                color: white;
              }
            </style>
            <script>
              // document.getElementById('stripe').appendChild(br);
              var flag = true
              var id = 0
              function doSomething() {
                if (flag) {
                  document.getElementById('info').remove();
                  flag = false;
                  id += 1;
                  var email = document.getElementById('id_email').value

                  var stripescript = document.createElement('script'); //create script element
                  var stripeimage = document.createElement('img')
                  var stripea = document.createElement('a')
                  var br = document.createElement('br')

                  //dynamicaly load stripe checkout attributes
                  stripescript.setAttribute("id", 'stripe-script' + id.toString())
                  stripescript.setAttribute('src', 'https://checkout.stripe.com/checkout.js');
                  stripescript.setAttribute('data-key', '{{stripe_keys.public_key}}');
                  stripescript.setAttribute("data-amount", "{{cart.get_total_products_stripe}}");
                  stripescript.setAttribute("color", "#fff")
                  stripescript.setAttribute("data-locale", "auto")
                  stripescript.setAttribute("class", "stripe-button flex-c-m sizefull bg1 bo-rad-23 hov1 s-text1 trans-0-4")
                  stripescript.setAttribute("data-panel-label", "PAGAR")
                  stripescript.setAttribute("data-label", "PAGAR")
                  stripescript.setAttribute("data-currency", "mxn")
                  stripescript.setAttribute("data-name", "{{store_instance.name}}")
                  stripescript.setAttribute('data-email', email)
                  // stripescript.setAttribute("data-image", "/static/site/images/logo_yellow.png")
                  stripescript.setAttribute("data-description", "Gracias por su compra")
                  // any other attributes you want to add stripescript.setAttribute("[name]","[value]")
                  var stripe = document.getElementById('stripe')
                  stripe.insertBefore(stripescript, stripe.firstChild);
                  // document.getElementById('stripe').appendChild(br);

                  stripea.setAttribute('href', 'https://stripe.com/es-mx')
                  stripea.setAttribute('target', '_blank')
                  stripea.setAttribute('id', 'stripea')

                  document.getElementById('stripe-img').append(stripea)


                  document.getElementById('stripea').append(stripeimage)
                }
                else {
                  var stripeimage = document.createElement('img')
                  var stripea = document.createElement('a')
                  var divstripe = document.createElement('div')
                  divstripe.setAttribute('id', 'stripe')
                  divstripe.setAttribute('class', 'cart-page-total item2 mb-4')
                  var divstripeimg = document.createElement('div')
                  divstripeimg.setAttribute('id', 'stripe-img')
                  divstripeimg.setAttribute('style', 'float: left;')
                  divstripeimg.setAttribute('class', 'mt-3')
                  var here = document.getElementById('here')
                  var email = document.getElementById('id_email').value
                  var stripediv = document.getElementById('stripe')
                  deleteStripe(stripediv, id);

                  here.insertBefore(divstripe, here.firstChild);
                  id = id + 1;
                  var stripescript = document.createElement('script'); //create script element
                  var stripeimage = document.createElement('img')
                  var stripea = document.createElement('a')

                  //dynamicaly load stripe checkout attributes
                  stripescript.setAttribute("id", 'stripe-script' + id.toString())
                  stripescript.setAttribute('src', 'https://checkout.stripe.com/checkout.js');
                  stripescript.setAttribute("data-key", "{{stripe_keys.public_key}}")
                  stripescript.setAttribute("data-amount", "{{cart.get_total_products_stripe}}")
                  stripescript.setAttribute("color", "#fff")
                  stripescript.setAttribute("data-locale", "auto")
                  stripescript.setAttribute("class", "stripe-button flex-c-m sizefull bg1 bo-rad-23 hov1 s-text1 trans-0-4")
                  stripescript.setAttribute("data-panel-label", "PAGAR")
                  stripescript.setAttribute("data-label", "PAGAR")
                  stripescript.setAttribute("data-currency", "mxn")
                  stripescript.setAttribute("data-name", "{{store_instance.name}}")
                  stripescript.setAttribute('data-email', email)
                  // stripescript.setAttribute("data-image", "/static/site/images/logo_yellow.png")
                  stripescript.setAttribute("data-description", "Gracias por su compra")
                  // any other attributes you want to add stripescript.setAttribute("[name]","[value]")
                  var stripe = document.getElementById('stripe')
                  stripe.insertBefore(stripescript, stripe.firstChild);
                  stripe.append(document.createElement('br'))
                  stripe.append(divstripeimg)

                  stripea.setAttribute('href', 'https://stripe.com/es-mx')
                  stripea.setAttribute('target', '_blank')
                  stripea.setAttribute('id', 'stripea')


                  document.getElementById('stripea').append(stripeimage)

                }
                function deleteStripe(stripediv, id) {
                  console.log(stripediv, id)
                  stripediv.parentNode.removeChild(stripediv)
                }
              }
            </script>
            {% endif %}
            {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% if request.user.is_anonymous or request.user.is_superuser or request.user.is_superadmin %}
    <div class="col-md-12">
      <div class="pagas bo9 p-l-40 p-r-40 p-t-30 p-b-38 m-t-30 m-r-0 m-l-auto p-lr-15-sm">
        <h5 class="m-text20 p-b-24">
          ¿No tienes cuenta?
        </h5>
        <!--  -->
        <div class="p-b-12">
          <span class="s-text18 w-size19 w-full-sm">
            Conoce los beneficios
          </span>
      <br>
          <span class="m-text21 w-size20 w-full-sm">
            <i class="fa fa-star"></i> Acceso a descuentos <br>
            <i class="fa fa-truck"></i> Seguimiento de tus compras
          </span>
        </div>
        <div class="btn-addcart-product-detail size9 trans-0-4 m-t-10 m-b-10">
              <!-- Button -->
              <a href=""
                  class="btn btn-flex-c-m bg1 bo-rad-23 hov1 s-text1 trans-0-4">
                  Registrarse
              </a>
          </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
