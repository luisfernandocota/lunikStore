{% load humanize %}
{% if step == 'informacion' %}

    <h5>Mi carrito de compras</h5>

    <nav aria-label="breadcrumb">

        <ol class="breadcrumb">

            <li class="breadcrumb-item"><a href="{% url 'shop:cart_detail' %}" class="text-primary">Carrito</a></li>

            <li id="informacion" class="breadcrumb-item active"><a style="font-weight: bold;" data-url="{% url 'shop:cart_checkout' %}?step=informacion" onclick="goStep($(this));" class="text-primary">Información</a></li>

            <li id="envio" class="breadcrumb-item"><a data-url="{% url 'shop:cart_checkout' %}?step=envio" onclick="goStep($(this));" class="text-primary">Envío</a></li>

            <li id="pago" class="breadcrumb-item"><a data-url="{% url 'shop:cart_checkout' %}?step=pago" onclick="goStep($(this));" class="text-primary">Método de pago</a></li>

        </ol>

    </nav>
    {% if not request.user.is_authenticated and not request.user.is_customer %}
    <div class="contact-information pt-4">

        <p class="fw-bold">

            Información de contacto

        </p>

        <p>

            ¿Ya tiene una cuenta?

            <a href="" class="text-primary">Iniciar sesión</a>

        </p>


        {% comment %} <form action="">

            <div class="form-floating mb-3">

                <input type="text" class="form-control" id="email_or_phone" placeholder="Email o número de teléfono">

                <label for="email_or_phone">Email o número de teléfono</label>

            </div>

            <div class="form-check">

                <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">

                <label class="form-check-label" for="flexCheckDefault">

                    Mantenerme informado para recibir increibles y exclusivas ofertas

                </label>

            </div>

        </form> {% endcomment %}

    </div>
    {% endif %}

    <div class="shipping-information pt-4">

        <p class="fw-bold">

            Dirección de envío

        </p>

        <form rol="form" method='POST' action="{% url 'shop:cart_address' %}" id="form-info" class="row g-0 js-form-info">
        {% csrf_token %}
            <input type="hidden" name="step" value="envio">
            <div class="form-floating mb-3 col-12 ">

                {{form_order.name}}

                <label for="name">Nombre</label>

            </div>

            <div class="form-floating mb-3 col-12 col-lg-7">

                {{form_order.email}}

                <label for="last_name">Correo</label>

            </div>
            <div class="form-floating mb-3 col-12 col-lg-5">

                {{form_order.phone}}

                <label for="phone">Teléfono</label>

            </div>
            <div class="form-floating mb-3 col-12 col-lg-6">

                {{form_delivery.address}}

                <label for="address">Dirección</label>

            </div>
            <div class="form-floating mb-3 col-12 col-lg-3">

                {{form_delivery.num_ext}}

                <label for="num_ext">Num ext.</label>

            </div>
            <div class="form-floating mb-3 col-12 col-lg-3">

                {{form_delivery.num_int}}

                <label for="num_ext">Num int.</label>

            </div>
            <div class="form-floating mb-3 col-12 col-lg-4">

                {{form_delivery.zip_code}}

                <label for="cp">Cod. Postal</label>

            </div>
            <div class="form-floating mb-3 col-12 col-lg-8">

                {{form_delivery.suburb}}

                <label for="suburb">Colonia</label>

            </div>
            

            <div class="form-floating mb-3 col-12 col-lg-6">

                {{form_delivery.city}}

                <label for="city">Ciudad</label>

            </div>

            <div class="form-floating mb-3 col-12 col-lg-6">

                {{form_delivery.state}}

                <label for="state">Estado</label>

            </div>



            {% comment %} <div class="form-check">

                <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">

                <label class="form-check-label" for="flexCheckDefault">

                    Guardar mis datos

                </label>

            </div> {% endcomment %}

        </form>

    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            let zipcode = document.getElementById('id_zip_code').value
            let url = '/dashboard/zipcode/info/?zipcode=' + zipcode
            $.ajax({
                url: url,
                data: {'zipcode':zipcode},
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    if(data){
                        $('#id_city').val(data.community);
                        $('#id_state').val(data.state);
                        if( $('#id_suburb').has('option').length == 0 ) {
                            $.each(data.suburbs, function (i, item) {
                                $('#id_suburb').append($('<option>', { 
                                    value: item,
                                    text : item 
                                }));
                            });
                        }
                        $("#id_suburb option[value='{{cart.get_suburb_by_address}}']").attr("selected", true);
                    }
                }
            });
        });
    </script>

{% elif step == 'envio' %}

    <h5>Mi carrito de compras</h5>

    <nav aria-label="breadcrumb">

        <ol class="breadcrumb">

            <li class="breadcrumb-item"><a href="{% url 'shop:cart_detail' %}" class="text-primary">Carrito</a></li>

            <li id="informacion" class="breadcrumb-item"><a data-url="{% url 'shop:cart_checkout' %}?step=informacion" onclick="goStep($(this));" class="text-primary">Información</a></li>

            <li id="envio" class="breadcrumb-item active"><a style="font-weight: bold;" data-url="{% url 'shop:cart_checkout' %}?step=envio" onclick="goStep($(this));" class="text-primary">Envío</a></li>

            <li id="pago" class="breadcrumb-item"><a data-url="{% url 'shop:cart_checkout' %}?step=pago" onclick="goStep($(this));" class="text-primary">Método de pago</a></li>

        </ol>

    </nav>

    <div class="shipping-information pt-4">

        <div class="p-2 row g-0" style="border: 1px solid #ced4da;">

            <div class="col-12 col-lg-3">

                <p class="mb-0" style="font-size: 14px;">Contacto</p>

            </div>

            <div class="col-12 col-lg-9">

                <p class="mb-0 text-end" style="font-size: 14px;">{{cart.get_email_by_address}}</p>

            </div>

            <div class="col-12">

                <hr class="mt-2 mb-2">

            </div>

            <div class="col-12 col-lg-3">

                <p class="mb-0" style="font-size: 14px;">Envíar a </p>

            </div>

            <div class="col-12 col-lg-9">

                <p class="mb-0 text-end" style="font-size: 14px;">{{cart.get_street_by_address}}</p>

            </div>

        </div>

    </div>

    <div class="contact-information pt-4">

        <p class="fw-bold">

            Método de envío

        </p>

        <div class="p-2 row g-0" style="border: 1px solid #ced4da;">
            
            <div class="col-12 col-lg-9">

                <div class="form-check">

                    <input class="form-check-input" onclick="radioCheck()"  style="background-color: var(--main-bg-color-branding) !important; border-color: var(--main-bg-color-branding) !important;" type="radio" name="shipping_method" id="default" value="default" 
                    {% if cart.get_shipping_method == 'default' %}checked{% endif %}>

                    <label class="form-check-label" for="default">

                        Recoger pedido

                    </label>

                    </div>

            </div>

            <div class="col-12 col-lg-3">

                <p class="mb-0 fw-bold text-end" {% if cart.get_shipping_method == 'default' %}style="font-size:20px;"{% endif %} id="p-default">GRATIS</p>

            </div>

            <div class="col-12 col-lg-9">

                <div class="form-check">

                    <input class="form-check-input" onclick="radioCheck()" style="background-color: var(--main-bg-color-branding) !important; border-color: var(--main-bg-color-branding) !important;" type="radio" name="shipping_method" id="local" value="local"  
                    {% if cart.get_shipping_method == 'local' %}checked{% endif %}>

                    <label class="form-check-label" for="local">

                        Envio local

                    </label>

                    </div>

            </div>

            <div class="col-12 col-lg-3">

                <p class="mb-0 fw-bold text-end" {% if cart.get_shipping_method == 'local' %}style="font-size:20px;"{% endif %} id="p-local" >$ 40.00</p>

            </div>

            <div class="col-12 col-lg-9">

                <div class="form-check">

                    <input class="form-check-input" onclick="radioCheck()"  style="background-color: var(--main-bg-color-branding) !important; border-color: var(--main-bg-color-branding) !important;" type="radio" name="shipping_method" id="nacional"value="nacional" 
                    {% if cart.get_shipping_method == 'nacional' %}checked{% endif %}>

                    <label class="form-check-label" for="nacional">

                        Envio nacional

                    </label>

                    </div>

            </div>

            <div class="col-12 col-lg-3">

                <p class="mb-0 fw-bold text-end" {% if cart.get_shipping_method == 'nacional' %}style="font-size:20px;"{% endif %} id="p-nacional">$ {{cart.get_shipping_total}}</p>

            </div>

        </div>

    </div>

{% elif step == 'pago' %}

    <h5>Mi carrito de compras</h5>

    <nav aria-label="breadcrumb">

        <ol class="breadcrumb">


                <li class="breadcrumb-item"><a href="{% url 'shop:cart_detail' %}" class="text-primary">Carrito</a></li>

                <li id="informacion" class="breadcrumb-item"><a data-url="{% url 'shop:cart_checkout' %}?step=informacion" onclick="goStep($(this));" class="text-primary">Información</a></li>

                <li id="envio" class="breadcrumb-item"><a data-url="{% url 'shop:cart_checkout' %}?step=envio" onclick="goStep($(this));" class="text-primary">Envío</a></li>

                <li id="pago" class="breadcrumb-item active"><a style="font-weight: bold;" data-url="{% url 'shop:cart_checkout' %}?step=pago" onclick="goStep($(this));" class="text-primary">Método de pago</a></li>

        </ol>

    </nav>

    <div class="shipping-information">

        <div class="p-2 row g-0" style="border: 1px solid #ced4da;">

            <div class="col-12 col-lg-3">

                <p class="mb-0" style="font-size: 14px;">Contacto</p>

            </div>

            <div class="col-12 col-lg-9">

                <p class="mb-0 text-end" style="font-size: 14px;">{{cart.get_email_by_address}}</p>

            </div>

            <div class="col-12">

                <hr class="mt-2 mb-2">

            </div>

            <div class="col-12 col-lg-3">

                <p class="mb-0" style="font-size: 14px;">Envíar a </p>

            </div>

            <div class="col-12 col-lg-9">

                <p class="mb-0 text-end" style="font-size: 14px;">{{cart.get_street_by_address}}</p>

            </div>

            <div class="col-12">

                <hr class="mt-2 mb-2">

            </div>

            <div class="col-12 col-lg-3">

                <p class="mb-0" style="font-size: 14px;">Método de envío</p>

            </div>

            <div class="col-12 col-lg-9">
                {% if cart.get_shipping_method == 'default' %}
                <p class="mb-0 text-end" style="font-size: 14px;"><span id="span-method">Recoger pedido</span><strong> Gratis</strong></p>
                {% elif cart.get_shipping_method == 'local' %}
                <p class="mb-0 text-end" style="font-size: 14px;"><span id="span-method">Local</span><strong> ${{cart.get_shipping_cost|intcomma}}</strong></p>
                {% elif cart.get_shipping_method == 'nacional' %}
                <p class="mb-0 text-end" style="font-size: 14px;"><span id="span-method">Nacional</span><strong> ${{cart.get_shipping_cost|intcomma}}</strong></p>
                {% endif %}

            </div>

        </div>

    </div> 

    <div class="contact-information">

        <p class="fw-bold mb-2 pt-4">

            Método de pago

        </p>

        <p>

            Todas las transacciones son seguras y encriptadas

        </p>

        <div class="p-2 row g-0" >

            <div class="d-flex d-flex justify-content-end">
                <form id="payment-form">
                    {% csrf_token %}
                    <div id="payment-element">
                      <!--Stripe.js injects the Payment Element-->
                    </div>
                    <button id="submit">
                      <div class="spinner hidden" id="spinner"></div>
                      <span id="button-text">Pagar</span>
                    </button>
                    <div id="payment-message" class="hidden"></div>
                  </form>

            </div>

        </div>

    </div>
    <script>
        // This is your test publishable API key.
        const stripe = Stripe("pk_test_51H5LaSIKF8Hi9Jx6Uetqcf1TSvBOFZBVTe69PKuV9Xir5fkMwC3O4bifcGS5cV41jDxQfdMJiTgjhAj5g0Mtf2Lo00WmU2jh8X");
    
    // The items the customer wants to buy
    const items = [{ id: "xl-tshirt" }];
    
    let elements;
    
    initialize();
    checkStatus();
    
    document
      .querySelector("#payment-form")
      .addEventListener("submit", handleSubmit);
    
    // Fetches a payment intent and captures the client secret
    async function initialize() {
      const response = await fetch("/carrito/checkout/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ items }),
      });
      const { clientSecret } = await response.json();
    
      const appearance = {
        theme: 'minimal',
      };
      elements = stripe.elements({ appearance, clientSecret });
    
      const paymentElement = elements.create("payment");
      paymentElement.mount("#payment-element");
    }
    
    async function handleSubmit(e) {
      e.preventDefault();
      setLoading(true);
    
      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          // Make sure to change this to your payment completion page
          return_url: "{% if request.is_secure %}https://{% else %}http://{% endif %}{{request.get_host}}{% url 'shop:cartPaymentIntent' %}",
        },
      });
      // This point will only be reached if there is an immediate error when
      // confirming the payment. Otherwise, your customer will be redirected to
      // your `return_url`. For some payment methods like iDEAL, your customer will
      // be redirected to an intermediate site first to authorize the payment, then
      // redirected to the `return_url`.
      if (error.type === "card_error" || error.type === "validation_error") {
        showMessage(error.message);
      } else {
        showMessage("An unexpected error occured.");
      }
    
      setLoading(false);
    }
    
    // Fetches the payment intent status after payment submission
    async function checkStatus() {
      const clientSecret = new URLSearchParams(window.location.search).get(
        "payment_intent_client_secret"
      );
    
      if (!clientSecret) {
        return;
      }
    
      const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);

      switch (paymentIntent.status) {
        case "succeeded":
          showMessage("Payment succeeded!");
          const response = await fetch("/carrito/checkout/retrievePayment/", {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentIntent }),
            });
          break;
        case "processing":
          showMessage("Your payment is processing.");
          break;
        case "requires_payment_method":
          showMessage("Your payment was not successful, please try again.");
          break;
        default:
          showMessage("Something went wrong.");
          break;
      }
    }
    
    // ------- UI helpers -------
    
    function showMessage(messageText) {
      const messageContainer = document.querySelector("#payment-message");
    
      messageContainer.classList.remove("hidden");
      messageContainer.textContent = messageText;
    
      setTimeout(function () {
        messageContainer.classList.add("hidden");
        messageText.textContent = "";
      }, 4000);
    }
    
    // Show a spinner on payment submission
    function setLoading(isLoading) {
      if (isLoading) {
        // Disable the button and show a spinner
        document.querySelector("#submit").disabled = true;
        document.querySelector("#spinner").classList.remove("hidden");
        document.querySelector("#button-text").classList.add("hidden");
      } else {
        document.querySelector("#submit").disabled = false;
        document.querySelector("#spinner").classList.add("hidden");
        document.querySelector("#button-text").classList.remove("hidden");
      }
    }
    </script>
{% endif %}

<script src="{{STATIC_URL}}js/cart.js"></script>
