{% load humanize %}
{% if step == 'informacion' %}

    {% if not request.user.is_authenticated and not request.user.is_customer %}
    <div class="p-t-4">

        <p class="fw-bold">

            Información de contacto

        </p>

        <p>

            ¿Ya tiene una cuenta?

            <a href="" class="text-primary">Iniciar sesión</a>

        </p>


        {% comment %} <form action="">

            <div class="form-floating mb-3">

                <input type="text" class="form-control" id="email_or_phone" placeholder="Email o número de teléfono">

                <label for="email_or_phone">Email o número de teléfono</label>

            </div>

            <div class="form-check">

                <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">

                <label class="form-check-label" for="flexCheckDefault">

                    Mantenerme informado para recibir increibles y exclusivas ofertas

                </label>

            </div>

        </form> {% endcomment %}

    </div>
    {% endif %}

    <div class="p-r-40">

        <form rol="form" method='POST' action="{% url 'shop:cart_address' %}" id="form-info" class="js-form-info" style="height: 750px;">
            <h4 class="m-text14 p-b-32">

                Ingresa tus datos de envío
    
            </h4>
        {% csrf_token %}
            <input type="hidden" name="step" value="envio">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12">
                        <div class="input-group p-b-10 p-t-10">
        
                            {{form_order.name}}
            
                            <label for="name" class="input-label">Nombre</label>
            
                        </div>
                    </div>
                    
        
                    <div class="col-12">
                        <div class="input-group p-b-10 p-t-10">
        
                            {{form_order.email}}
        
                            <label for="last_name" class="input-label">Correo</label>
        
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="input-group p-b-10 p-t-10">
        
                            {{form_order.phone}}
        
                            <label for="phone" class="input-label">Teléfono</label>
        
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="input-group p-b-10 p-t-10">
        
                            {{form_delivery.address}}
        
                            <label for="address" class="input-label">Dirección</label>
        
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-6 col-lg-6">
                        <div class="input-group p-b-10 p-t-10">
        
                            {{form_delivery.num_ext}}
        
                            <label for="num_ext" class="input-label">Num ext.</label>
        
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-6">
                        <div class="input-group p-b-10 p-t-10">
        
                            {{form_delivery.num_int}}
        
                            <label for="num_int" class="input-label">Num int.</label>
        
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-6">
                        <div class="input-group p-b-10 p-t-10">
        
                            {{form_delivery.zip_code}}
        
                            <label for="cp" class="input-label">Cod. Postal</label>
        
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-6">
                        <div class="input-group p-b-10 p-t-10">
        
                            {{form_delivery.suburb}}
        
                            <label for="suburb" class="input-label">Colonia</label>
        
                        </div>
                    </div>
                    
        
                    <div class="col-12 col-md-6 col-lg-6">
                        <div class="input-group p-b-10 p-t-10">
        
                            {{form_delivery.city}}
        
                            <label for="city" class="input-label">Ciudad</label>
        
                        </div>
                    </div>
        
                    <div class="col-12 col-md-6 col-lg-6">
                        <div class="input-group p-b-10 p-t-10">
        
                        {{form_delivery.state}}
        
                        <label for="state" class="input-label">Estado</label>
                        </div>
                    </div>
                </div>
                
            </div>
            



            {% comment %} <div class="form-check">

                <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault">

                <label class="form-check-label" for="flexCheckDefault">

                    Guardar mis datos

                </label>

            </div> {% endcomment %}

        </form>

    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            var zipcode = $('#id_zip_code').val();
            let url = '/dashboard/zipcode/info/'
            {% if cart.get_address_order %}

            $.ajax({
                url: url,
                data: {'zipcode':zipcode},
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    if(data){
                        $('#id_city').val(data.community);
                        $('#id_state').val(data.state);
                        if( $('#id_suburb').has('option').length == 0 ) {
                            $.each(data.suburbs, function (i, item) {
                                $('#id_suburb').append($('<option>', { 
                                    value: item,
                                    text : item 
                                }));
                            });
                        }
                        $("#id_suburb option[value='{{cart.get_suburb_by_address}}']").attr("selected", true);
                    }
                }
            });
            {% endif %}
            $('#id_zip_code').blur(function() {
                let zipcode = $('#id_zip_code').val();
                $.ajax({
                    url: url,
                    data: {'zipcode':zipcode},
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        if(data){
                            $('#id_city').val(data.community);
                            $('#id_state').val(data.state);
                            $('#id_suburb').empty();

                                $.each(data.suburbs, function (i, item) {
                                    $('#id_suburb').append($('<option>', { 
                                        value: item,
                                        text : item 
                                    }));
                                });

                        }
                    }
                });
            });
        });
    </script>

{% elif step == 'envio' %}

    <div class=" p-lr-15 p-t-20 container-option">

        <div class="row">

            <div class="col-12 col-lg-3">

                <span class="s-text18 w-size19 w-full-sm">
                    Contacto
                </span>

            </div>

            <div class="col-12 col-lg-9">

                <p class="mb-0 text-end" style="font-size: 14px;">{{cart.get_email_by_address}}</p>

            </div>

            <div class="col-12">

                <hr class="mt-2 mb-2">

            </div>

            <div class="col-12 col-lg-3">

                <span class="s-text18 w-size19 w-full-sm">
                    Enviar a
                </span>

            </div>

            <div class="col-12 col-lg-9">

                <p class="mb-0 text-end" style="font-size: 14px;">{{cart.get_street_by_address}}</p>

            </div>

        </div>

    </div>

    <div class="p-lr-15 p-t-20">

        <h4 class="m-text14 p-b-12">

            Método de envío

        </h4>

        <div class="row container-option m-r-3" >
            <div class="container select-option container-default">
                <div class="row ">
                    <div class="col-lg-1 icon-check">
                        <i class="default-check visible-false fa fa-check-circle fa-2x" style="color: #da9fa6;"></i>
                    </div>
                    <div class="col-12 col-lg-8">

                        <div class="form-check">

                            <input class="visible-false"  style="background-color: var(--main-bg-color-branding) !important; border-color: var(--main-bg-color-branding) !important;" type="radio" name="shipping_method" id="default" value="default" 
                            {% if cart.get_shipping_method == 'default' %}checked{% endif %}>
        
                            <label class="form-check-label">
        
                                Recoger pedido
        
                            </label>
        
                        </div>
        
                    </div>
        
                    <div class="col-12 col-lg-3">
        
                        <p class="mb-0 fw-bold text-end" {% if cart.get_shipping_method == 'default' %}style="font-size:20px;color:#914c54;"{% endif %} id="p-default">¡Gratis! <i class="fa fa-bolt" style="color:#914c54"></i></p>
        
                    </div>
                </div>
                
            </div>
            
            
            <div class="col-12">

                <hr class="mt-2 mb-2">

            </div>
            <div class="container select-option container-local">
                <div class="row ">
                    <div class="col-lg-1 icon-check">
                        <i class="local-check visible-false fa fa-check-circle fa-2x" style="color: #da9fa6;"></i>
                    </div>
                    <div class="col-12 col-lg-8">

                        <div class="form-check">

                            <input class="visible-false" style="background-color: var(--main-bg-color-branding) !important; border-color: var(--main-bg-color-branding) !important;" type="radio" name="shipping_method" id="local" value="local"  
                            {% if cart.get_shipping_method == 'local' %}checked{% endif %}>

                            <label class="form-check-label">

                                Envio local (Ciudad Los Mochis, Sin, México.)

                            </label>

                            </div>

                    </div>
                    <div class="col-12 col-lg-3">

                        <p class="mb-0 fw-bold text-end" {% if cart.get_shipping_method == 'local' %} style="font-size:20px;color:#914c54;"{% endif %} id="p-local" > {% if cart.get_shipping_total > 0 %}$40.00{% else %}¡Gratis! <i class="fa fa-bolt" style="color:#914c54"></i>{% endif %}</p>
        
                    </div>
                </div>
            </div>

            

            <div class="col-12">

                <hr class="mt-2 mb-2">

            </div>

            <div class="container select-option container-nacional">
                <div class="row ">
                    <div class="col-lg-1 icon-check">
                        <i class="nacional-check visible-false fa fa-check-circle fa-2x" style="color: #da9fa6;"></i>
                    </div>
                    <div class="col-12 col-lg-8">

                        <div class="form-check">

                            <input class="visible-false" style="background-color: var(--main-bg-color-branding) !important; border-color: var(--main-bg-color-branding) !important;" type="radio" name="shipping_method" id="nacional"value="nacional" 
                            {% if cart.get_shipping_method == 'nacional' %}checked{% endif %}>

                            <label class="form-check-label">

                                Envio nacional (México)

                            </label>

                            </div>

                    </div>

                    <div class="col-12 col-lg-3">

                        <p class="mb-0 fw-bold text-end" {% if cart.get_shipping_method == 'nacional' %}style="font-size:20px;color:#914c54;"{% endif %} id="p-nacional">{% if cart.get_shipping_total > 0 %}${{cart.get_shipping_total}}{% else %}¡Gratis! <i class="bi bi-lightning" style="color:#914c54"></i>{% endif %}</p>

                    </div>
                </div>
            </div>
        </div>

    </div>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function(){
        

            if($(this).find('input[type="radio"]').is(':checked')){
                $(this).find('.{{cart.get_shipping_method}}-check').toggleClass('visible-false');
                
                $(this).find('input[type="radio"]').prop('checked', false);
                $(this).removeClass('selected-option');

            }
            else{

                $(this).addClass('selected-option');
                $(this).find('input[type="radio"]').prop('checked', true);
            }
        });
        $('.select-option').click(function(){
            let method = '';
            if($(this).hasClass('container-default')){
                if(!$('.container-local').find('.local-check').hasClass('visible-false')){
                    $('.container-local').find('.local-check').toggleClass('visible-false');

                }
                if(!$('.container-nacional').find('.nacional-check').hasClass('visible-false')){
                    $('.container-nacional').find('.nacional-check').toggleClass('visible-false');

                }
                
                if($('.container-local').hasClass('selected-option')){
                    $('.container-local').toggleClass('selected-option')
                }
                if($('.container-nacional').hasClass('selected-option')){
                    $('.container-nacional').toggleClass('selected-option')

                }
                method = 'default';
            } else if ($(this).hasClass('container-local')){
                if(!$('.container-default').find('.default-check').hasClass('visible-false')){
                    $('.container-default').find('.default-check').toggleClass('visible-false');

                }
                if(!$('.container-nacional').find('.nacional-check').hasClass('visible-false')){
                    $('.container-nacional').find('.nacional-check').toggleClass('visible-false');


                }

                if($('.container-default').hasClass('selected-option')){
                    $('.container-default').toggleClass('selected-option')
                }
                if($('.container-nacional').hasClass('selected-option')){
                    $('.container-nacional').toggleClass('selected-option')              
                }
                method = 'local';

            } else if ($(this).hasClass('container-nacional')){
                if(!$('.container-default').find('.default-check').hasClass('visible-false')){
                    $('.container-default').find('.default-check').toggleClass('visible-false');

                }
                if(!$('.container-local').find('.local-check').hasClass('visible-false')){
                    $('.container-local').find('.local-check').toggleClass('visible-false');

                }

                if($('.container-local').hasClass('selected-option')){
                    $('.container-local').toggleClass('selected-option')
                    
                }
                if($('.container-default').hasClass('selected-option')){
                    $('.container-default').toggleClass('selected-option')
                }
                method = 'nacional';

            }
            if($(this).find('input[type="radio"]').is(':checked')){
                
                $(this).find('input[type="radio"]').prop('checked', false);
                $(this).removeClass('selected-option');

            }
            else{
                radioCheck(method);
                $(this).find('.fa-check-circle').toggleClass('visible-false');
                $(this).addClass('selected-option');
                $(this).find('input[type="radio"]').prop('checked', true);
            }
        })
    </script>

{% elif step == 'pago' %}

    <div class="p-lr-15 p-t-20 container-option">

        <div class="row">

            <div class="col-12 col-lg-3">

                <p class="mb-0" style="font-size: 14px;">Contacto</p>

            </div>

            <div class="col-12 col-lg-9">

                <p class="mb-0 text-end" style="font-size: 14px;">{{cart.get_email_by_address}}</p>

            </div>

            <div class="col-12">

                <hr class="mt-2 mb-2">

            </div>

            <div class="col-12 col-lg-3">

                <p class="mb-0" style="font-size: 14px;">Envíar a </p>

            </div>

            <div class="col-12 col-lg-9">

                <p class="mb-0 text-end" style="font-size: 14px;">{{cart.get_street_by_address}}</p>

            </div>

            <div class="col-12">

                <hr class="mt-2 mb-2">

            </div>

            <div class="col-12 col-lg-3">

                <p class="mb-0" style="font-size: 14px;">Método de envío</p>

            </div>

            <div class="col-12 col-lg-9">
                {% if cart.get_shipping_method == 'default' %}
                <p class="mb-0 text-end" style="font-size: 14px;"><span id="span-method">Recoger pedido</span><strong> {% if cart.get_shipping_cost > 0 %}${{cart.get_shipping_cost|intcomma}}{% else %}¡Gratis! <i class="bi bi-lightning" style="color:#914c54"></i>{% endif %}</strong></p>
                {% elif cart.get_shipping_method == 'local' %}
                <p class="mb-0 text-end" style="font-size: 14px;"><span id="span-method">Local</span><strong> {% if cart.get_shipping_cost > 0 %}${{cart.get_shipping_cost|intcomma}}{% else %}¡Gratis! <i class="bi bi-lightning" style="color:#914c54"></i>{% endif %}</strong></p>
                {% elif cart.get_shipping_method == 'nacional' %}
                <p class="mb-0 text-end" style="font-size: 14px;"><span id="span-method">Nacional</span><strong> {% if cart.get_shipping_cost > 0 %}${{cart.get_shipping_cost|intcomma}}{% else %}¡Gratis! <i class="bi bi-lightning" style="color:#914c54"></i>{% endif %}</strong></p>
                {% endif %}

            </div>

        </div>

    </div> 

    <div class="p-lr-15 p-t-30">

        <h4 class="m-text14 p-b-12">

            Método de pago

        </h4>

        <p>

            Todas las transacciones son seguras y encriptadas

        </p>

        <div class="row flex-c p-t-30" >

            <div id="payment-div" class="t-center well">
                <form id="payment-form" style="width: 45vw !important; border-radius: 10px;">
                    {% csrf_token %}
                    <div id="payment-element" >
                      <!--Stripe.js injects the Payment Element-->
                    </div>
                    <button id="submit">
                      <div class="spinner hidden" id="spinner"></div>
                      <span id="button-text">Pagar</span>
                    </button>
                    <div id="payment-message" class="hidden"></div>
                  </form>

            </div>

        </div>

    </div>
    <script>
    
    // The items the customer wants to buy
    const items = [{ id: "xl-tshirt" }];
    
    let elements;
    
    initialize();
    checkStatus();
    
    document
      .querySelector("#payment-form")
      .addEventListener("submit", handleSubmit);
    
    // Fetches a payment intent and captures the client secret
    async function initialize() {

        var paymentdiv = document.getElementById('payment-div')
        paymentdiv.classList.add('sk-loading');
        paymentdiv.innerHTML += '<div id="loader-bar" class="loader text-center"><span class="bar"></span><span class="bar"></span><span class="bar"></span> </div>';
        var loader = document.getElementById('loader-bar')
      
        const response = await fetch("/carrito/checkout/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ items }),
        });
        const { clientSecret } = await response.json();
            
        const appearance = {
            theme: 'flat',
        };
        elements = stripe.elements({ appearance, clientSecret });
    
        const paymentElement = elements.create("payment");
        paymentElement.mount("#payment-element");
        paymentdiv.classList.remove('sk-loading');
        loader.parentNode.removeChild(loader);
    }
    
    async function handleSubmit(e) {
      e.preventDefault();
      setLoading(true);
      const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: {
          // Make sure to change this to your payment completion page
          return_url: "{% if request.is_secure %}https://{% else %}http://{% endif %}{{request.get_host}}{% url 'shop:cartPaymentIntent' %}",
        },
      });
      // This point will only be reached if there is an immediate error when
      // confirming the payment. Otherwise, your customer will be redirected to
      // your `return_url`. For some payment methods like iDEAL, your customer will
      // be redirected to an intermediate site first to authorize the payment, then
      // redirected to the `return_url`.
      if (error.type === "card_error" || error.type === "validation_error") {
        showMessage(error.message);
      } else {
        showMessage("An unexpected error occured.");
      }
    
      setLoading(false);
    }
    
    // Fetches the payment intent status after payment submission
    async function checkStatus() {
      const clientSecret = new URLSearchParams(window.location.search).get(
        "payment_intent_client_secret"
      );
    
      if (!clientSecret) {
        return;
      }
    
      const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);

      switch (paymentIntent.status) {
        case "succeeded":
          showMessage("Payment succeeded!");
          const response = await fetch("/carrito/checkout/retrievePayment/", {
                method: "GET",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentIntent }),
            });
          break;
        case "processing":
          showMessage("Your payment is processing.");
          break;
        case "requires_payment_method":
          showMessage("Your payment was not successful, please try again.");
          break;
        default:
          showMessage("Something went wrong.");
          break;
      }
    }
    
    // ------- UI helpers -------
    
    function showMessage(messageText) {
      const messageContainer = document.querySelector("#payment-message");
    
      messageContainer.classList.remove("hidden");
      messageContainer.textContent = messageText;
    
      setTimeout(function () {
        messageContainer.classList.add("hidden");
        messageText.textContent = "";
      }, 4000);
    }
    
    // Show a spinner on payment submission
    function setLoading(isLoading) {
      if (isLoading) {
        // Disable the button and show a spinner
        console.log('hola')
        document.querySelector("#submit").disabled = true;
        document.querySelector("#spinner").classList.remove("hidden");
        document.querySelector("#button-text").classList.add("hidden");
      } else {
        document.querySelector("#submit").disabled = false;
        document.querySelector("#spinner").classList.add("hidden");
        document.querySelector("#button-text").classList.remove("hidden");
      }
    }
    </script>
{% endif %}

<script src="{{STATIC_URL}}js/cart.js"></script>
